server:
  port: 8080
  
spring:
  application:
    name: api-gateway

  profiles:
    active: test
  
  # Redis Sentinel 설정
  data:
    redis:
      sentinel:
        master: mymaster
        nodes:
          - redis-sentinel-0.redis-sentinel.shop-msa.svc.cluster.local:26379
      password: ${REDIS_PASSWORD:}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
  
  # Spring Cloud Gateway 라우팅 설정
  # 현재 왜인지 동작안하므로 config 직접설정
  # -> PREFIX 가 바뀜
  # PREFIX = "spring.cloud.gateway.server.webflux"
  cloud:
      gateway:
        server:
          webflux:
            routes:
            - id: user-service
              uri: http://localhost:8081
              predicates:
              - Path=/api/users/**
              filters:
              - StripPrefix=0
              - name: CircuitBreaker
                args:
                  name: userServiceCircuitBreaker
                  fallbackUri: forward:/fallback/user-service
              - name: Retry
                args:
                  retries: 3
                  statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                  methods: GET,POST,PUT,DELETE
                  backoff:
                    firstBackoff: 100ms
                    maxBackoff: 500ms
                    factor: 2
            # Payment Service (중요 서비스)
            - id: payment-service
              uri: http://localhost:8082
              predicates:
                - Path=/api/payments/**
              filters:
                - StripPrefix=0
                - name: CircuitBreaker
                  args:
                    name: paymentServiceCircuitBreaker
                    fallbackUri: forward:/fallback/payment-service
                - name: Retry
                  args:
                    retries: 2 # 결제는 멱등성 보장이 어려우므로 재시도 줄임
                    statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                    methods: GET # POST는 중복 결제 위험으로 제외
                    backoff:
                      firstBackoff: 200ms
                      maxBackoff: 1000ms
                      factor: 2
            # HTTP 클라이언트 설정
            httpclient:
              connect-timeout: 3000
              response-timeout: 10s
              pool:
                type: ELASTIC
                max-idle-time: 30s
                max-life-time: 60s
        
        # # Settlement Service
        # - id: settlement-service
        #   uri: http://localhost:8083
        #   predicates:
        #     - Path=/api/settlements/**
        #   filters:
        #     - StripPrefix=0
        #     - name: CircuitBreaker
        #       args:
        #         name: settlementServiceCircuitBreaker
        #         fallbackUri: forward:/fallback/settlement-service
        #     - name: Retry
        #       args:
        #         retries: 3
        #         statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
        #         methods: GET,POST,PUT,DELETE
        #         backoff:
        #           firstBackoff: 100ms
        #           maxBackoff: 500ms
        #           factor: 2
        
        # # Partner Service
        # - id: partner-service
        #   uri: http://localhost:8084
        #   predicates:
        #     - Path=/api/partners/**
        #   filters:
        #     - StripPrefix=0
        #     - name: CircuitBreaker
        #       args:
        #         name: partnerServiceCircuitBreaker
        #         fallbackUri: forward:/fallback/partner-service
        #     - name: Retry
        #       args:
        #         retries: 3
        #         statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
        #         methods: GET,POST,PUT,DELETE
        #         backoff:
        #           firstBackoff: 100ms
        #           maxBackoff: 500ms
        #           factor: 2
        
        # # Accounting Service
        # - id: accounting-service
        #   uri: http://localhost:8085
        #   predicates:
        #     - Path=/api/accounting/**
        #   filters:
        #     - StripPrefix=0
        #     - name: CircuitBreaker
        #       args:
        #         name: accountingServiceCircuitBreaker
        #         fallbackUri: forward:/fallback/accounting-service
        #     - name: Retry
        #       args:
        #         retries: 3
        #         statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
        #         methods: GET,POST,PUT,DELETE
        #         backoff:
        #           firstBackoff: 100ms
        #           maxBackoff: 500ms
        #           factor: 2
      
      # 글로벌 CORS 설정
      # globalcors:
      #   cors-configurations:
      #     '[/**]':
      #       allowedOriginPatterns: "*"
      #       allowedMethods:
      #         - GET
      #         - POST
      #         - PUT
      #         - PATCH
      #         - DELETE
      #         - OPTIONS
      #       allowedHeaders: "*"
      #       allowCredentials: true
      #       maxAge: 3600

# Actuator 설정 (Health Check, Metrics)
management:
  endpoints:
    web:
      exposure:
        include: "*"
        # include: health,info,metrics,prometheus,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      # access: unrestricted
      access: read-only
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
  # 모니터링 강화
  prometheus:
    metrics:
      export:
        enabled: true
        
# Resilience4j 설정
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        slowCallRateThreshold: 60
        slowCallDurationThreshold: 3s
        recordExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.util.concurrent.TimeoutException
          - java.io.IOException
    instances:
      paymentCircuitBreaker:
        baseConfig: default
        failureRateThreshold: 40
        waitDurationInOpenState: 60s
        slowCallDurationThreshold: 2s
      userCircuitBreaker:
        baseConfig: default
      settlementCircuitBreaker:
        baseConfig: default
      partnerCircuitBreaker:
        baseConfig: default
      accountingCircuitBreaker:
        baseConfig: default
  
  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
    instances:
      paymentCircuitBreaker:
        timeoutDuration: 5s

#Swagger 설정
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    use-root-path: true
    enabled: true
    path: /swagger-ui.html
    urls:
    - name: User Service
      url: /v3/api-docs/user-service
    # - name: Payment Service
    #   url: /v3/api-docs/payment-service
    # - name: Settlement Service
    #   url: /v3/api-docs/settlement-service
    # - name: Partner Service
    #   url: /v3/api-docs/partner-service
    # - name: Accounting Service
    #   url: /v3/api-docs/accounting-service

# 로깅 설정
logging:
  level:
    root: INFO
    "[com.payment.gateway]": DEBUG
    "[org.springframework.cloud.gateway]": DEBUG
    "[org.springframework.web]": DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
